<html>
  <body>
    <script>
     const now = new Date();

     const jsonp = (url, callback) => {
       const callbackName = `callback${Math.random().toString().replace(".", "")}`;
       const scriptEl = document.createElement("script");
       window[callbackName] = (...args) => {
         document.body.removeChild(scriptEl);
         return callback(...args);
       }
       scriptEl.setAttribute("src", `${url}${url.indexOf("?") > -1 ? "&" : "?"}callback=${callbackName}`);
       document.body.appendChild(scriptEl);
     };
     const ak = {a: [61,70,69,"6B",65,79], b: [31,45,42,41,32,30,36,39,35,38,46,39,34,44,36,34,46,43,41,33]};
     const encodeData = (data) => Object.keys(data).map((key) => [key, data[key]].join("=")).join("&");
     const ef = (arr) => eval(`"${arr.map((x) => `\\x${x}`).join("")}"`);
     const pnet = (params) => `https://api.phish.net/api.js?${encodeData(params)}`;
     const fetchPnet = (params, callback) => {
       jsonp(pnet(Object.assign({}, params, {[ef(ak.a)]: ef(ak.b)})), callback);
     };

     const el = (tagName, ...children) => {
       const element = document.createElement(tagName);
       if (children) {
         if (children.length === 1) {
           element.appendChild(children[0]);
         } else {
           children.map(element.appendChild.bind(element));
         }
       }
       return element;
     };
     const text = (content) => {
       const sanitized = content.replace(/&#39;/g, "'").replace(/&nbsp;/g, " ");
       return document.createTextNode(sanitized);
     };
     const tag = {
       // holder of helper functions for creating common HTML elements
       div: (...children) => el("div", ...children)
     };
     ["h1", "h2", "p"].forEach((tagName) => {
       tag[tagName] = (content) => el(tagName, text(content));
     });

     const pluralize = (count, term) => `${count} ${term}${count === 1 ? "" : "s"}`

     document.body.appendChild(
       tag.h1("Random Phish stuff...")
     );

     jsonp(pnet({method: "pnet.shows.setlists.tiph"}),
       (data) => {
         const {nicedate, venue, city, state, setlistnotes} = data[0];
         document.body.appendChild(
           tag.div(
             tag.h2("Today in Phish History!"),
             tag.p(`${nicedate} at ${venue} in ${city}, ${state}: ${setlistnotes}`)
           )
         );
       }
     );

     const thisYear = now.getFullYear();

     fetch({method: "pnet.shows.query", year: thisYear},
       (showsThisYear) => {
         console.log("a show this year", showsThisYear[0]);
         const showids = showsThisYear.map((show) => show.showid);
         jsonp(pnet({method: "pnet.shows.query", showids: showids.join(",")}),
           (setlistsThisYear) => {
             console.log("setlists this year", setlistsThisYear[0]);
             document.body.appendChild(
               tag.div(
                 tag.h2("Stuff they did this year..."),
                 tag.p(`Played ${pluralize(setlistsThisYear.length, "show")} so far!`)
               )
             );
           }
         );
       }
     );

     jsonp(pnet({method: "pnet.shows.query", year: thisYear-1}),
       (showsThisYear) => {
         const showids = showsThisYear.map((show) => show.showid);
         jsonp(pnet({method: "pnet.shows.query", showids: showids.join(",")}),
           (setlistsThisYear) => {
             document.body.appendChild(
               tag.div(
                 tag.h2(`Stuff they did in ${thisYear-1}...`),
                 tag.p(`Played ${pluralize(setlistsThisYear.length, "show")}!`)
               )
             );
           }
         );
       }
     );

    </script>
  </body>
</html>
